<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VN Admin 2025 – Web Example</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
    .form-group { margin: 10px 0; }
    label { display: inline-block; width: 120px; font-weight: bold; }
    select, input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
    button { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
    button:hover { background: #0056b3; }
    pre { background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>VN Admin 2025 – Demo (Vanilla JS)</h1>

  <div class="section">
    <h2>Search Example</h2>
    <input id="q" placeholder="vd: Hà Nội, ha noi, hn" />
    <button id="btn">Search</button>
    <pre id="out"></pre>
  </div>

  <div class="section">
    <h2>Province + Commune Selection</h2>
    <div class="form-group">
      <label for="province-select">Tỉnh/Thành phố:</label>
      <select id="province-select">
        <option value="">-- Chọn tỉnh/thành phố --</option>
      </select>
    </div>
    <div class="form-group">
      <label for="commune-select">Phường/Xã:</label>
      <select id="commune-select" disabled>
        <option value="">-- Chọn phường/xã --</option>
      </select>
    </div>
    <div class="form-group">
      <button id="get-selection">Get Selected Values</button>
    </div>
    <pre id="selection-out"></pre>
  </div>

  <script>
    async function loadProvinces() {
      const res = await fetch('../../data/generated/provinces.json');
      return await res.json();
    }

    async function loadCommunesByProvince(provinceCode) {
      const res = await fetch(`../../data/generated/communes_by_province/${provinceCode}.json`);
      return await res.json();
    }

    function normalize(s) {
      return s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/gi,'d').toLowerCase();
    }

    (async () => {
      const provinces = await loadProvinces();
      const out = document.getElementById('out');
      const selectionOut = document.getElementById('selection-out');
      const provinceSelect = document.getElementById('province-select');
      const communeSelect = document.getElementById('commune-select');

      // Search functionality
      const queryFn = () => {
        const q = normalize(document.getElementById('q').value.trim());
        const found = q.length ? provinces.filter(p => (p.tokens||[]).some(t => t.includes(q))) : provinces;
        out.textContent = JSON.stringify(found.slice(0, 10), null, 2);
      };

      document.getElementById('btn').onclick = queryFn;
      document.getElementById('q').onkeydown = (e) => {
        if (e.key === 'Enter') {
          queryFn();
        }
      };

      // Populate province selectbox
      provinces.forEach(province => {
        const option = document.createElement('option');
        option.value = province.code;
        option.textContent = province.name_vi;
        provinceSelect.appendChild(option);
      });

      // Province selection handler
      provinceSelect.onchange = async (e) => {
        const selectedCode = e.target.value;

        // Reset commune select
        communeSelect.innerHTML = '<option value="">-- Chọn phường/xã --</option>';
        communeSelect.disabled = !selectedCode;

        if (selectedCode) {
          try {
            const communes = await loadCommunesByProvince(selectedCode);
            communes.forEach(commune => {
              const option = document.createElement('option');
              option.value = commune.code;
              option.textContent = commune.name_vi;
              communeSelect.appendChild(option);
            });
          } catch (error) {
            console.error('Error loading communes:', error);
            communeSelect.innerHTML = '<option value="">-- Không có dữ liệu --</option>';
          }
        }
      };

      // Get selection button handler
      document.getElementById('get-selection').onclick = () => {
        const selectedProvince = provinces.find(p => p.code === provinceSelect.value);
        const selectedCommuneCode = communeSelect.value;

        const result = {
          province: selectedProvince || null,
          commune_code: selectedCommuneCode || null,
          commune_name: communeSelect.options[communeSelect.selectedIndex]?.text || null
        };

        selectionOut.textContent = JSON.stringify(result, null, 2);
      };
    })();
  </script>
</body>
</html>
